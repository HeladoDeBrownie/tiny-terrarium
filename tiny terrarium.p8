pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
-- tiny terrarium
-- by helado de brownie
-->8
-- constants

-- board sizes larger than
-- 64x64 cause glitches because
-- they overlap the section of
-- the sprite sheet that the
-- move function uses for
-- metadata.
board_width,board_height=32,32

water= 1 -- dark blue
clay = 4 -- brown
block= 5 -- dark gray
air  =12 -- light blue
sand =15 -- tan
-->8
-- state

cursor_x,cursor_y=0,0
-->8
-- functions

-- move the atom at (x1,y1) into
-- (x2,y2). this results in
-- either a swap, a fusion, or
-- no change:
-- - swap the two atoms if the
--   destination is air.
-- - fuse the two atoms if
--   there is a fusion reaction
--   specified for them by the
--   fuse function.
-- - do nothing otherwise or if
--   either atom has already
--   moved this turn.
-- precondition: (x1,y1) is in
-- bounds.
function
move(x1,y1,x2,y2)
	local air=air
	local in_bounds2=
		0<=x2 and x2<board_width and
		0<=y2 and y2<board_height
	-- out of bounds atoms don't
	-- exist but are considered to
	-- be air.
	local atom2=
		in_bounds2 and
		sget(x2,y2) or
		air

	-- do nothing if either atom
	-- has been swapped this turn.
	if
		sget(x1+64,y1)~=0 or
		(in_bounds2 and
		sget(x2+64,y2)~=0)
	then
		return false
	end

	local atom1=sget(x1,y1)

	-- swap with air.
	if atom2==air then
		-- only copy (x1,y1) to
		-- (x2,y2) if the latter is
		-- in bounds.
		if in_bounds2 then
			sset(x2,y2,atom1)
			sset(x2+64,y2,1)
		end

		-- copy the air to (x1,y1),
		-- which is assumed to be in
		-- bounds.
		sset(x1,y1,air)
		sset(x1+64,y1,1)
		return true
	-- try to fuse anything else.
	else
		local f=fuse(atom1,atom2)
		if(f==nil)return false
		sset(x1,y1,air)
		sset(x1+64,y1,1)
		sset(x2,y2,f)
		sset(x2+64,y1,1)
		return true
	end
end

-- return the atom that the two
-- given atoms fuse into if one
-- exists, otherwise nil.
function fuse(atom1,atom2)
	local water=water
	local sand=sand
	-- water & sand -> clay
	if
		(atom1==water and
		 atom2==sand)
		or
		(atom1==sand and
		 atom2==water)
	then
		return clay
	end
end
-->8
-- hooks

function
_update()
	-- repeatedly looking up local
	-- variables is faster than
	-- doing so with globals.
	local bw,bh=
		board_width,board_height
	local water=water
	local clay=clay
	local sand=sand

	-- move the cursor based on
	-- user input.
	if(btn(⬅️))cursor_x-=1
	if(btn(➡️))cursor_x+=1
	if(btn(⬆️))cursor_y-=1
	if(btn(⬇️))cursor_y+=1
	cursor_x,cursor_y=
		mid(0,cursor_x,bw-1),
		mid(0,cursor_y,bh-1)

	-- simulate each atom.
	for y=0,bh-1 do
		for x=0,bw-1 do
			local atom=sget(x,y)
			-- water falls straight
			-- down if able, or else
			-- moves left or right or
			-- stays still at random.
			if atom==water then
				if not move(x,y,x,y+1) then
					local side=flr(rnd(3))-1
					move(x,y,x+side,y)
				end
			-- clay falls straight down.
			elseif atom==clay then
				move(x,y,x,y+1)
			-- sand falls straight down,
			-- left, or right at random.
			elseif atom==sand then
				local side=flr(rnd(3))-1
				move(x,y,x+side,y+1)
			end
		end
	end

	-- we're done moving things;
	-- forget this turn's moves.
	poke(0x5f55,0x00)
	rectfill(64,0,128,64,0)
	poke(0x5f55,0x60)
end

function
_draw()
	local bw,bh=
		board_width,board_height

	-- fill the screen with the
	-- board. because normally
	-- nothing will show through,
	-- we don't need to clear the
	-- screen explicitly.
	sspr(
		-- sprite sheet position
		0,0,
		-- sprite size
		bw,bh,
		-- screen position
		0,0,
		-- screen size
		128,128
	)

	-- draw the cursor.
	-- compute width and height
	-- based on screen and board
	-- sizes.
	local cw,ch=128/bw,128/bh
	-- compute screen position
	-- based on logical position
	-- and cursor size.
	local csx,csy=
		cursor_x*cw,cursor_y*ch
	-- draw it as a black outline.
	rect(
		csx,csy,
		csx+cw,csy+ch,
		0
	)
end
__gfx__
ffffffffffffffffffffffffffffffff000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cffffffffffffffffffffffffffffffc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccffffffffffffffffffffffffffffcc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccffffffffffffffffffffffffffccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccffffffffffffffffffffffffcccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccffffffffffffffffffffffccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccffffffffffffffffffffcccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccffffffffffffffffffccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5cc5cccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccc555cccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5cc5c555c5c5cccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc55c5c5c5c555cccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccccccccccccccc5cccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccccccccccccc55ccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
c55555cccccccccccccccc5ccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5cccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c555c55c55cc55c55c5c5c5c555c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c55cc5cc5cc5c5c5cc5c5c5c555c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c5ccc5cc5cc555c5cc5c5c5c5c5c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c555c5cc5cc5c5c5cc5c555c5c5c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5c11111cc11111c5cccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5555555555555555cccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
