pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
-- tiny terrarium
-- by helado de brownie
-->8
-- glossary
-- this is a comment-only tab
-- explaining the terminology
-- used throughout the code.

-- atom:
-- an individual particle that
-- is independently simulated.
-- every atom is represented by
-- a pico-8 color, or,
-- equivalently, an integer
-- from 0 to 15 inclusive. the
-- game state is completely
-- determined by what colors
-- are in what places.
-- atoms come in multiple types
-- that have their own special
-- interactions with other
-- atoms. these are described
-- by the comments in the
-- _update function.

-- board:
-- the place where the
-- simulation happens. it takes
-- up the entire screen and is
-- a rectangular grid of tiles,
-- each of which contains
-- exactly one atom, no more or
-- less.

-- move:
-- to move an atom from one
-- tile to an adjacent tile
-- means to swap it with air if
-- the latter tile has air in
-- it, or else to attempt a
-- special reaction. these
-- reactions are determined by
-- the bump function.

-- tile:
-- a place on the board. it is
-- identified by a pair of
-- coordinates, integers that
-- are at least zero and at
-- most one less than the
-- respective dimension of the
-- board. a tile always has
-- exactly one atom in it.

-- turn:
-- one logical frame, which
-- happens about thirty times
-- per second. the board state
-- advances once per turn. this
-- is when all the rules and
-- relations between atoms are
-- checked.
-->8
-- optimization
-- this is a comment-only tab
-- explaining the optimization
-- principles used throughout
-- the code.

-- because most computations in
-- this code happen potentially
-- hundreds of times per frame,
-- it's very important to do
-- things as cheap as possible.
-- the primary way that pico-8
-- makes it easy to follow
-- performance properties is
-- using its built-in cpu meter
-- that can be toggled by
-- pressing ctrl+p while a cart
-- is running. the middle and
-- right numbers should read as
-- less than 1.00 as much of
-- the time as possible.
-- some optimization principles
-- are used throughout the
-- source code, which are
-- explained here.

-- use local variables for
-- repeated lookups.
-- looking up global variables
-- is significantly slower than
-- looking up locals, even when
-- no other computations are
-- involved. a function can be
-- sped up without changing the
-- rest of its code just by
-- inserting a local definition
-- at the beginning that has
-- the same name as a global
-- that is referred to more
-- than once, and is set to the
-- value of that global. e.g.,
-- 	local air=air

-- compute everything once.
-- nontrivial computations such
-- as performing arithmetic or
-- comparisons on values tend
-- to be slower than reading
-- local variables or
-- parameters. functions should
-- be designed so that they can
-- accept information that is
-- already known or otherwise
-- use preconditions, i.e.,
-- assume the inputs are valid
-- instead of checking them
-- when it is known ahead of
-- time that the function will
-- only be called on valid
-- inputs.

-- inline.
-- writing separate functions
-- is useful for the sake of
-- code reuse, but calling them
-- has a cost that is not
-- always worth the tradeoff.
-- avoid calling functions when
-- it would noticeably slow
-- down the code, and instead
-- write the logic at the site
-- it's used.
-- this principle in particular
-- should only be applied when
-- it leads to *observable*
-- performance increase, in
-- order to offset its tendency
-- to make logic harder to
-- follow or make code harder
-- to maintain.
-->8
-- constants

-- board sizes larger than
-- 64x64 cause glitches because
-- they overlap the section of
-- the sprite sheet that the
-- move function uses for
-- metadata.
board_width,board_height=32,32

water= 1 -- dark blue
clay = 4 -- brown
block= 5 -- dark gray
air  =12 -- light blue
oil  =13 -- lavender
sand =15 -- tan
-->8
-- state

cursor_x,cursor_y=0,0
-->8
-- functions

-- move the atom at (x1,y1) to
-- (x2,y2). this results in
-- either a swap, a fusion, or
-- no change:
-- - swap the two atoms if the
--   destination is air.
-- - apply a specific
--   interaction if there is
--   one specified for them by
--   the bump function.
-- - do nothing otherwise or if
--   either atom has already
--   moved this turn.
-- precondition: (x1,y1) is in
-- bounds.
function
move(x1,y1,x2,y2)
	local air=air
	local in_bounds2=
		0<=x2 and x2<board_width and
		0<=y2 and y2<board_height
	-- out of bounds atoms don't
	-- exist but are considered to
	-- be air.
	local atom2=
		in_bounds2 and
		sget(x2,y2) or
		air

	-- do nothing if either atom
	-- has been swapped this turn.
	if
		sget(x1+64,y1)~=0 or
		(in_bounds2 and
		sget(x2+64,y2)~=0)
	then
		return false
	end

	local atom1=sget(x1,y1)

	-- swap with air.
	if atom2==air then
		-- only copy (x1,y1) to
		-- (x2,y2) if the latter is
		-- in bounds.
		if in_bounds2 then
			sset(x2,y2,atom1)
			sset(x2+64,y2,1)
		end

		-- copy the air to (x1,y1),
		-- which is assumed to be in
		-- bounds.
		sset(x1,y1,air)
		sset(x1+64,y1,1)
		return true
	-- check anything else for
	-- special interactions.
	else
		local f1,f2=bump(atom1,atom2)
		if(f1==nil)return false
		sset(x1,y1,f2 or air)
		sset(x1+64,y1,1)
		sset(x2,y2,f1)
		sset(x2+64,y2,1)
		return true
	end
end

-- return the atoms that the
-- two atoms turn into when
-- one moves into the other,
-- or otherwise nil. the first
-- of the results is the atom
-- placed at the destination,
-- and the second is placed at
-- the source. the second is
-- implicitly air if it's not
-- specified.
function bump(atom1,atom2)
	local water=water
	local sand=sand
	-- water & sand -> clay
	if
		(atom1==water and
		 atom2==sand)
		or
		(atom1==sand and
		 atom2==water)
	then
		return clay
	-- water & oil -> oil rises
	elseif
		atom1==water and
		atom2==oil
	then
		return water,oil
	end
end
-->8
-- hooks

function
_update()
	-- repeatedly looking up local
	-- variables is faster than
	-- doing so with globals.
	local bw,bh=
		board_width,board_height
	local water=water
	local clay=clay
	local oil=oil
	local sand=sand

	-- move the cursor based on
	-- user input.
	if(btn(⬅️))cursor_x-=1
	if(btn(➡️))cursor_x+=1
	if(btn(⬆️))cursor_y-=1
	if(btn(⬇️))cursor_y+=1
	cursor_x,cursor_y=
		mid(0,cursor_x,bw-1),
		mid(0,cursor_y,bh-1)

	-- simulate each atom.
	for y=0,bh-1 do
		for x=0,bw-1 do
			local atom=sget(x,y)
			-- water and oil fall
			-- straight down if able, or
			-- else move left or right
			-- or stay still at random.
			if
				atom==water or
				atom==oil
			then
				if not move(x,y,x,y+1) then
					local side=flr(rnd(3))-1
					move(x,y,x+side,y)
				end
			-- clay falls straight down.
			elseif atom==clay then
				move(x,y,x,y+1)
			-- sand falls straight down,
			-- left, or right at random.
			elseif atom==sand then
				local side=flr(rnd(3))-1
				move(x,y,x+side,y+1)
			end
		end
	end

	-- we're done moving things;
	-- forget this turn's moves.
	poke(0x5f55,0x00)
	rectfill(64,0,128,64,0)
	poke(0x5f55,0x60)
end

function
_draw()
	local bw,bh=
		board_width,board_height

	-- fill the screen with the
	-- board. because normally
	-- nothing will show through,
	-- we don't need to clear the
	-- screen explicitly.
	sspr(
		-- sprite sheet position
		0,0,
		-- sprite size
		bw,bh,
		-- screen position
		0,0,
		-- screen size
		128,128
	)

	-- draw the cursor.
	-- compute width and height
	-- based on screen and board
	-- sizes.
	local cw,ch=128/bw,128/bh
	-- compute screen position
	-- based on logical position
	-- and cursor size.
	local csx,csy=
		cursor_x*cw,cursor_y*ch
	-- draw it as a black outline.
	rect(
		csx,csy,
		csx+cw,csy+ch,
		0
	)
end
__gfx__
ffffffffffffffffffffffffffffffff000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cffffffffffffffffffffffffffffffc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccffffffffffffffffffffffffffffcc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccffffffffffffffffffffffffffccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccffffffffffffffffffffffffcccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccffffffffffffffffffffffccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccffffffffffffffffffffcccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccffffffffffffffffffccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5cc5cccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccc555cccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5cc5c555c5c5cccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc55c5c5c5c555cccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccccccccccccccc5cccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccccccccccccccccc55ccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
c55555cccccccccccccccc5ccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5cccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c555c55c55cc55c55c5c5c5c555c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c55cc5cc5cc5c5c5cc5c5c5c555c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c5ccc5cc5cc555c5cc5c5c5c5c5c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
ccc5c555c5cc5cc5c5c5cc5c555c5c5c000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccccccccccccccccccccccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5c11111cc11111c5cccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
cccccccc5555555555555555cccccccc000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111
